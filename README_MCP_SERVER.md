# FastAPI MCP Server

A Model Context Protocol (MCP) server for FastAPI applications that provides tools to discover routes, generate test cases, list tests, and run tests.

## Features

- **HTTP Transport Mode**: Runs on `http://127.0.0.1:8001/mcp`
- **No Authentication Required**: Simple, direct access
- **Four Powerful Tools**:
  1. `discover_routes` - Introspect FastAPI apps to find all registered routes
  2. `generate_test_cases` - Auto-generate pytest test functions
  3. `list_tests` - Discover all pytest tests
  4. `run_tests` - Execute pytest with custom arguments

## Installation

Install the required dependencies:

```bash
pip install fastapi pytest mcp
```

## Usage

### Start the Server

```bash
python fastapi_mcp_server_http.py
```

The server will start on `http://127.0.0.1:8001/mcp`

### Available Tools

#### 1. discover_routes

Discover all registered routes in a FastAPI application.

**Request:**
```bash
curl -X POST http://127.0.0.1:8001/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "tool": "discover_routes",
    "arguments": {
      "app_import_path": "myapp.main:app"
    }
  }'
```

**Response:**
```json
{
  "success": true,
  "data": {
    "app_import_path": "myapp.main:app",
    "total_routes": 5,
    "routes": [
      {
        "methods": ["GET"],
        "path": "/",
        "name": "root",
        "endpoint": "read_root"
      },
      {
        "methods": ["POST"],
        "path": "/items",
        "name": "create_item",
        "endpoint": "create_item"
      }
    ]
  }
}
```

#### 2. generate_test_cases

Generate pytest test functions for FastAPI routes.

**Request:**
```bash
curl -X POST http://127.0.0.1:8001/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "tool": "generate_test_cases",
    "arguments": {
      "app_import_path": "myapp.main:app",
      "output_path": "tests/test_generated.py",
      "sample_values": {
        "/items": {
          "name": "Test Item",
          "price": 29.99
        }
      }
    }
  }'
```

**Response:**
```json
{
  "success": true,
  "data": {
    "message": "Generated 5 test cases in tests/test_generated.py",
    "test_count": 5,
    "output_path": "tests/test_generated.py"
  }
}
```

#### 3. list_tests

List all discovered pytest tests using `--collect-only`.

**Request:**
```bash
curl -X POST http://127.0.0.1:8001/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "tool": "list_tests",
    "arguments": {
      "test_path": "tests/"
    }
  }'
```

**Response:**
```json
{
  "success": true,
  "data": {
    "command": "python -m pytest --collect-only -q tests/",
    "return_code": 0,
    "stdout": "test_generated.py::test_get_root\ntest_generated.py::test_post_create_item\n...",
    "stderr": ""
  }
}
```

#### 4. run_tests

Run pytest tests with optional arguments.

**Request:**
```bash
curl -X POST http://127.0.0.1:8001/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "tool": "run_tests",
    "arguments": {
      "test_path": "tests/",
      "args": ["-v", "--tb=short"]
    }
  }'
```

**Response:**
```json
{
  "success": true,
  "data": {
    "command": "python -m pytest tests/ -v --tb=short",
    "return_code": 0,
    "stdout": "===== test session starts =====\n...",
    "stderr": "",
    "success": true
  }
}
```

## Example FastAPI Application

Here's a sample FastAPI app to test with:

```python
# myapp/main.py
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
def read_root():
    return {"message": "Hello World"}

@app.post("/items")
def create_item(name: str, price: float):
    return {"name": name, "price": price}
```

## Generated Test Example

The `generate_test_cases` tool creates tests like this:

```python
"""
Auto-generated pytest tests for FastAPI application.
Generated by FastAPI MCP Server.
"""

import pytest
from fastapi.testclient import TestClient
from myapp.main import app


@pytest.fixture
def client():
    """Create a test client for the FastAPI app."""
    return TestClient(app)


def test_get_read_root(client):
    """Test GET /"""
    response = client.get("/")
    # Basic assertion - adjust as needed
    assert response.status_code in [200, 201, 204, 404], f"Unexpected status: {response.status_code}"


def test_post_create_item(client):
    """Test POST /items"""
    data = {
        "name": "Test Item",
        "price": 29.99
    }
    response = client.post("/items", json=data)
    # Basic assertion - adjust as needed
    assert response.status_code in [200, 201, 204, 404], f"Unexpected status: {response.status_code}"
```

## API Endpoint

- **Base URL**: `http://127.0.0.1:8001/mcp`
- **Method**: POST
- **Content-Type**: `application/json`

**Request Format:**
```json
{
  "tool": "tool_name",
  "arguments": {
    "param1": "value1",
    "param2": "value2"
  }
}
```

## Error Handling

All responses include a `success` field:

- `"success": true` - Operation completed successfully
- `"success": false` - Operation failed, check the `error` field

Example error response:
```json
{
  "success": false,
  "error": "Failed to import FastAPI app from 'myapp.main:app': No module named 'myapp'"
}
```

## Notes

- Tests are generated conservatively with basic assertions
- POST/PUT endpoints accept sample values for request bodies
- All pytest commands run with a 120-second timeout
- The server supports CORS for browser-based clients

## License

MIT
